<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pages/Searcher.jsx - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Admin">Admin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ArenasVerdes">ArenasVerdes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#CardPage">CardPage</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Clima">Clima</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Contact">Contact</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ForgotPassword">ForgotPassword</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Index">Index</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Loberia">Loberia</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PanelAdmin">PanelAdmin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PartidoLoberia">PartidoLoberia</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Register">Register</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ResetPassword">ResetPassword</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Routing">Routing</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#SanManuel">SanManuel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Searcher">Searcher</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Suscribe">Suscribe</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#i18n">i18n</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#navigate">navigate</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">pages/Searcher.jsx</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import axios from "axios";
import React, {
  useEffect,
  useState,
  useCallback,
  useRef,
  useMemo,
} from "react";
import Button from "react-bootstrap/Button";
import Form from "react-bootstrap/Form";
import Pagination from "react-bootstrap/Pagination";
import { FaSearch } from "react-icons/fa";
import { useLocation, useSearchParams } from "react-router-dom";
import ContentCard from "../components/cards/ContentCard";
import "../styles/searcher.css";
import { useTranslation } from "react-i18next";
import { trackEvent } from "../analytics";
import { Global } from "../helpers/Global";

/**
 * Componente `Searcher`.
 *
 * Permite buscar contenido filtrando por nombre, ciudad y categoría.
 * Muestra sugerencias dinámicas mientras se escribe, paginación, y resultados en tarjetas.
 * Permite edición y eliminación de tarjetas si el usuario es admin.
 *
 * @component
 * @param {Object} props
 * @param {boolean} [props.isAdmin=false] - Indica si el usuario tiene permisos de administrador.
 * @param {Function|null} [props.onEdit=null] - Función que se ejecuta al editar una tarjeta.
 * @example
 * &lt;Searcher isAdmin={true} onEdit={(id) => console.log(id)} />
 *
 * @returns {JSX.Element} Componente de búsqueda con filtros y resultados.
 */
const Searcher = ({ isAdmin = false, onEdit = null }) => {
  const location = useLocation();
  const { t, i18n } = useTranslation();
  const [searchParams] = useSearchParams();

  /** Estado de las tarjetas resultantes de la búsqueda */
  const [cards, setCards] = useState([]);

  /** Estado del texto buscado */
  const [search, setSearch] = useState("");

  /** Estado de la ciudad filtrada */
  const [city, setCity] = useState(location.state?.city || "");

  /** Estado de la categoría filtrada */
  const [category, setCategory] = useState(location.state?.category || "");

  /** Estado de la página actual para paginación */
  const [page, setPage] = useState(1);

  /** Estado del total de páginas */
  const [totalPages, setTotalPages] = useState(1);

  /** Estado de las sugerencias mientras se escribe */
  const [suggestions, setSuggestions] = useState([]);

  const limit = 6;

  /** Referencias para valores actuales de búsqueda y filtros */
  const searchRef = useRef(search);
  const cityRef = useRef(city);
  const categoryRef = useRef(category);
  const pageRef = useRef(page);

  useEffect(() => {
    searchRef.current = search;
    cityRef.current = city;
    categoryRef.current = category;
    pageRef.current = page;
  }, [search, city, category, page]);

  /** Categorías disponibles para búsqueda */
  const categoriasDisponibles = useMemo(
    () => [
      "Alojamiento",
      "Gastronomia",
      "Cultura",
      "Evento",
      "Interes",
      "Artesanos",
      "ServPublicos",
      "InfoUtil",
    ],
    []
  );

  /**
   * Convierte un buffer de imagen en Base64 para mostrarla.
   * @param {Object} buffer - Objeto con data de la imagen.
   * @returns {string|null} Cadena base64 de la imagen o null si no hay data.
   */
  const bufferToBase64 = useCallback((buffer) => {
    if (!buffer?.data) return null;
    const binary = buffer.data.reduce(
      (acc, byte) => acc + String.fromCharCode(byte),
      ""
    );
    return `data:image/jpeg;base64,${window.btoa(binary)}`;
  }, []);

  /**
   * Obtiene las tarjetas desde el backend según filtros y página actual.
   */
  const fetchCards = useCallback(async () => {
    try {
      const params = {
        ...(searchRef.current &amp;&amp; { title: searchRef.current }),
        ...(cityRef.current &amp;&amp; { city: cityRef.current }),
        ...(categoryRef.current &amp;&amp; { category: categoryRef.current }),
        page: pageRef.current,
        limit,
      };

      const response = await axios.get(`${Global.url}cards`, { params });
      const cardsDB = response.data.cards || response.data;
      const total = response.data.total || cardsDB.length;

      const parsed = cardsDB.map((card) => {
        trackEvent({
          category: "Resultados",
          action: "Card vista",
          label: card.card_title,
        });
        return {
          ...card,
          img: bufferToBase64(card.card_img_portada),
        };
      });

      setCards(parsed);
      setTotalPages(Math.ceil(total / limit));
    } catch (error) {
      console.error("Error al obtener las cards:", error);
      setCards([]);
    }
  }, [limit, bufferToBase64]);

  /**
   * Obtiene sugerencias de títulos y categorías mientras el usuario escribe.
   * @param {string} texto - Texto ingresado en la barra de búsqueda.
   */
  const fetchSuggestions = useCallback(
    async (texto) => {
      try {
        const response = await axios.get(`${Global.url}cards`, {
          params: { title: texto, limit: 5 },
        });

        const titles =
          response.data.cards?.map((c) => ({
            type: "title",
            id: c.id,
            value: c.card_title,
          })) || [];

        const categories = categoriasDisponibles
          .filter((cat) => cat.toLowerCase().includes(texto.toLowerCase()))
          .map((cat) => ({ type: "category", value: cat }));

        setSuggestions([...titles, ...categories]);
      } catch (error) {
        console.error("Error al obtener sugerencias:", error);
        setSuggestions([]);
      }
    },
    [categoriasDisponibles]
  );

  /** Inicializa búsqueda desde URL y tracking de vista de página */
  useEffect(() => {
    const titleFromUrl = searchParams.get("title");
    if (titleFromUrl) setSearch(titleFromUrl);
    trackEvent({
      category: "Páginas",
      action: "Vista página",
      label: "Buscador",
    });
  }, [searchParams]);

  /** Ejecuta fetchCards al cambiar filtros o página */
  useEffect(() => {
    const timer = setTimeout(() => {
      fetchCards();
      trackEvent({
        category: "Búsqueda",
        action: "Filtros cambiados",
        label: `Página: ${page}, Búsqueda: ${search}, Ciudad: ${city}, Categoría: ${category}`,
      });
    }, 300);
    return () => clearTimeout(timer);
  }, [fetchCards, page, search, city, category]);

  /** Maneja sugerencias mientras el usuario escribe */
  useEffect(() => {
    if (search.length &lt; 2) {
      setSuggestions([]);
      return;
    }
    const timer = setTimeout(() => {
      fetchSuggestions(search);
    }, 300);
    return () => clearTimeout(timer);
  }, [search, fetchSuggestions]);

  /**
   * Maneja la selección de una sugerencia.
   * @param {Object} s - Sugerencia seleccionada.
   */
  const handleSuggestionClick = (s) => {
    if (s.type === "title") {
      setSearch(s.value);
      setPage(1);
    } else if (s.type === "category") {
      setCategory(s.value);
      setSearch("");
      setPage(1);
    }
    setSuggestions([]);
  };

  /**
   * Elimina una tarjeta por ID si el usuario es admin.
   * @param {string|number} cardId - ID de la tarjeta a eliminar.
   */
  const handleDeleteCard = async (cardId) => {
    try {
      const response = await axios.delete(`${Global.url}cards/${cardId}`);
      if (response.status === 200) fetchCards();
    } catch (error) {
      console.error("Error al eliminar la card:", error);
    }
  };

  /**
   * Ejecuta la función de edición si el usuario es admin.
   * @param {string|number} cardId - ID de la tarjeta a editar.
   */
  const handleEditCard = (cardId) => {
    if (onEdit) onEdit(cardId);
  };

  /**
   * Resetea todos los filtros y búsqueda.
   */
  const handleReset = () => {
    setSearch("");
    setCity("");
    setCategory("");
    setPage(1);
    setSuggestions([]);
    trackEvent({
      category: "Botón",
      action: "Limpiar filtros",
      label: "Buscador",
    });
  };

  return (
    &lt;div className="search-page" key={i18n.language}>
      &lt;main className="search-main">
        &lt;h1 className="search-title">{t("busqueda_contenido")}&lt;/h1>

        {/* Barra de búsqueda y sugerencias */}
        &lt;div className="search-bar">
          &lt;div className="search-input-group">
            &lt;input
              type="text"
              placeholder={t("buscar_por_nombre")}
              value={search}
              onChange={(e) => {
                setSearch(e.target.value);
                setPage(1);
                trackEvent({
                  category: "Buscador",
                  action: "Búsqueda por nombre",
                  label: e.target.value,
                });
              }}
            />
            &lt;button onClick={fetchCards}>
              &lt;FaSearch />
            &lt;/button>
          &lt;/div>
          {suggestions.length > 0 &amp;&amp; (
            &lt;ul className="suggestions-dropdown">
              {suggestions.map((s, i) => (
                &lt;li
                  key={i}
                  className="suggestion-item"
                  onClick={() => handleSuggestionClick(s)}
                >
                  &lt;span>{s.value}&lt;/span>
                  &lt;span className="suggestion-type">
                    {s.type === "title" ? " (Título)" : " (Categoría)"}
                  &lt;/span>
                &lt;/li>
              ))}
            &lt;/ul>
          )}
        &lt;/div>

        {/* Filtros */}
        &lt;div className="search-filters">
          &lt;Form.Select
            value={city}
            onChange={(e) => {
              setCity(e.target.value);
              setPage(1);
              trackEvent({
                category: "Filtro",
                action: "Ciudad seleccionada",
                label: e.target.value || "Todas",
              });
            }}
          >
            &lt;option value="">{t("ciudad")}&lt;/option>
            &lt;option value="Lobería">{t("ciudad_loberia")}&lt;/option>
            &lt;option value="Arenas Verdes">{t("arenas_verdes")}&lt;/option>
            &lt;option value="San Manuel">{t("san_manuel")}&lt;/option>
          &lt;/Form.Select>

          &lt;Form.Select
            value={category}
            onChange={(e) => {
              setCategory(e.target.value);
              setPage(1);
              trackEvent({
                category: "Filtro",
                action: "Categoría seleccionada",
                label: e.target.value || "Todas",
              });
            }}
          >
            &lt;option value="">{t("categoria")}&lt;/option>
            &lt;option value="Alojamiento">{t("alojamiento")}&lt;/option>
            &lt;option value="Gastronomia">{t("gastronomia")}&lt;/option>
            &lt;option value="Cultura">{t("cultura")}&lt;/option>
            &lt;option value="Evento">{t("evento")}&lt;/option>
            &lt;option value="Interes">{t("lugares_interes")}&lt;/option>
            &lt;option value="Artesanos">{t("artesanos")}&lt;/option>
            &lt;option value="ServPublicos">{t("servicios_publicos")}&lt;/option>
            &lt;option value="InfoUtil">{t("info_util")}&lt;/option>
          &lt;/Form.Select>

          &lt;Button
            className="btn-reset"
            variant="outline-secondary"
            onClick={handleReset}
          >
            {t("limpiar_filtros")}
          &lt;/Button>
        &lt;/div>

        {/* Filtros activos */}
        {(search || city || category) &amp;&amp; (
          &lt;div className="active-filters">
            &lt;strong>{t("filtros_activos")}: &lt;/strong>
            {search &amp;&amp; (
              &lt;span className="filter-tag">
                {t("busqueda")}: {search}
              &lt;/span>
            )}
            {city &amp;&amp; (
              &lt;span className="filter-tag">
                {t("ciudad")}: {city}
              &lt;/span>
            )}
            {category &amp;&amp; (
              &lt;strong className="filter-tag">
                {t("categoria")}: {category}
              &lt;/strong>
            )}
          &lt;/div>
        )}

        {/* Resultados */}
        &lt;div className="results-grid">
          {cards.length > 0 ? (
            cards.map((card) => (
              &lt;ContentCard
                key={card.id}
                id={card.id}
                title={card.card_title}
                description={card.card_description}
                city={card.card_city}
                img={card.img}
                category={card.card_category}
                card_date={card.card_date}
                {...(isAdmin &amp;&amp; {
                  onEdit: handleEditCard,
                  onDelete: handleDeleteCard,
                })}
              />
            ))
          ) : (
            &lt;div className="no-results">
              &lt;p>{t("no_se_encontraron_resultados")}&lt;/p>
            &lt;/div>
          )}
        &lt;/div>

        {/* Paginación */}
        {totalPages > 1 &amp;&amp; (
          &lt;Pagination className="pagination-container">
            &lt;Pagination.First
              onClick={() => setPage(1)}
              disabled={page === 1}
            />
            &lt;Pagination.Prev
              onClick={() => setPage((p) => Math.max(p - 1, 1))}
              disabled={page === 1}
            />
            {Array.from({ length: totalPages }, (_, i) => (
              &lt;Pagination.Item
                key={i}
                active={i + 1 === page}
                onClick={() => setPage(i + 1)}
              >
                {i + 1}
              &lt;/Pagination.Item>
            ))}
            &lt;Pagination.Next
              onClick={() => setPage((p) => Math.min(p + 1, totalPages))}
              disabled={page === totalPages}
            />
            &lt;Pagination.Last
              onClick={() => setPage(totalPages)}
              disabled={page === totalPages}
            />
          &lt;/Pagination>
        )}
      &lt;/main>
    &lt;/div>
  );
};

export default Searcher;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Wed Sep 10 2025 13:58:13 GMT-0300 (hora estándar de Argentina) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
